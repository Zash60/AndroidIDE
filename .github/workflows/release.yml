name: Release Build

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version (e.g., 1.0.0)'
        required: true
        default: '1.0.0'

env:
  JAVA_VERSION: '17'

jobs:
  release:
    name: Build & Release
    runs-on: ubuntu-latest
    timeout-minutes: 45
    permissions:
      contents: write

    steps:
      - name: ðŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Get Version
        id: version
        run: |
          if [ "${{ github.event.inputs.version }}" != "" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION="${GITHUB_REF#refs/tags/v}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: â˜• Setup JDK
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'
          cache: gradle

      - name: ðŸ¤– Setup Android SDK
        uses: android-actions/setup-android@v3

      - name: ðŸ“¥ Download SDK Dependencies
        run: |
          chmod +x ./scripts/download-sdk.sh
          ./scripts/download-sdk.sh

      - name: ðŸ”‘ Setup Signing
        env:
          KEYSTORE_BASE64: ${{ secrets.KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ]; then
            echo "$KEYSTORE_BASE64" | base64 -d > app/release.keystore
            echo "KEYSTORE_FILE=release.keystore" >> $GITHUB_ENV
            echo "KEYSTORE_PASSWORD=$KEYSTORE_PASSWORD" >> $GITHUB_ENV
            echo "KEY_ALIAS=$KEY_ALIAS" >> $GITHUB_ENV
            echo "KEY_PASSWORD=$KEY_PASSWORD" >> $GITHUB_ENV
            echo "HAS_SIGNING=true" >> $GITHUB_ENV
          else
            echo "HAS_SIGNING=false" >> $GITHUB_ENV
          fi

      - name: ðŸ”‘ Grant Execute Permission
        run: chmod +x gradlew

      - name: ðŸ§ª Run Tests
        run: ./gradlew test --stacktrace

      - name: ðŸ”¨ Build Release APK (Signed)
        if: env.HAS_SIGNING == 'true'
        run: ./gradlew assembleRelease --stacktrace

      - name: ðŸ”¨ Build Release APK (Unsigned)
        if: env.HAS_SIGNING != 'true'
        run: ./gradlew assembleRelease --stacktrace

      - name: ðŸ“ Rename APK
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [ -f "app/build/outputs/apk/release/app-release.apk" ]; then
            mv app/build/outputs/apk/release/app-release.apk \
               app/build/outputs/apk/release/AndroidIDE-v${VERSION}.apk
            echo "APK_NAME=AndroidIDE-v${VERSION}.apk" >> $GITHUB_ENV
          else
            mv app/build/outputs/apk/release/app-release-unsigned.apk \
               app/build/outputs/apk/release/AndroidIDE-v${VERSION}-unsigned.apk
            echo "APK_NAME=AndroidIDE-v${VERSION}-unsigned.apk" >> $GITHUB_ENV
          fi

      - name: ðŸ“Š Generate Checksums
        run: |
          cd app/build/outputs/apk/release/
          sha256sum ${{ env.APK_NAME }} > ${{ env.APK_NAME }}.sha256
          md5sum ${{ env.APK_NAME }} > ${{ env.APK_NAME }}.md5

      - name: ðŸ“¤ Upload Release APK
        uses: actions/upload-artifact@v4
        with:
          name: AndroidIDE-release-v${{ steps.version.outputs.version }}
          path: |
            app/build/outputs/apk/release/${{ env.APK_NAME }}
            app/build/outputs/apk/release/${{ env.APK_NAME }}.sha256
            app/build/outputs/apk/release/${{ env.APK_NAME }}.md5
          retention-days: 365

      - name: ðŸ“¤ Upload Mapping File
        uses: actions/upload-artifact@v4
        with:
          name: mapping-v${{ steps.version.outputs.version }}
          path: app/build/outputs/mapping/release/
          retention-days: 365
          if-no-files-found: ignore

      - name: ðŸ“ Generate Changelog
        id: changelog
        run: |
          # Pegar changelog do Ãºltimo tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD)
          else
            CHANGELOG=$(git log --pretty=format:"- %s" -20)
          fi
          
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸš€ Create GitHub Release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          name: Android IDE v${{ steps.version.outputs.version }}
          body: |
            ## ðŸ“± Android IDE v${{ steps.version.outputs.version }}
            
            ### ðŸ“¥ Download
            - **APK**: `${{ env.APK_NAME }}`
            
            ### ðŸ“‹ Changelog
            ${{ steps.changelog.outputs.changelog }}
            
            ### âœ… Checksums
            - SHA256: Ver arquivo `.sha256`
            - MD5: Ver arquivo `.md5`
            
            ### ðŸ“Œ Requirements
            - Android 8.0 (API 26) ou superior
            - ~100MB de espaÃ§o livre
            
          files: |
            app/build/outputs/apk/release/${{ env.APK_NAME }}
            app/build/outputs/apk/release/${{ env.APK_NAME }}.sha256
            app/build/outputs/apk/release/${{ env.APK_NAME }}.md5
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
